"use strict";

// Class definition
var KTSignupGeneral = (function () {
  // Elements
  var form;
  var submitButton;
  var validator;
  var passwordMeter;

  // Handle form
  var handleForm = function (e) {
    // Init form validation rules. For more info check the FormValidation plugin's official documentation:https://formvalidation.io/
    validator = FormValidation.formValidation(form, {
      fields: {
        email: {
          validators: {
            regexp: {
              regexp: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
              message: i18next.t("the value is not a valid email address"),
            },
            notEmpty: {
              message: i18next.t("email address is required"),
            },
          },
        },
        password: {
          validators: {
            notEmpty: {
              message: i18next.t("password is required"),
            },
            callback: {
              message: i18next.t("please enter valid password"),
              callback: function (input) {
                if (input.value.length < 8) {
                  return validatePassword();
                }
              },
            },
          },
        },
        "confirm-password": {
          validators: {
            notEmpty: {
              message: i18next.t("password confirmation is required"),
            },
            identical: {
              compare: function () {
                return form.querySelector('[name="password"]').value;
              },
              message: i18next.t("password and its confirm are not the same"),
            },
          },
        },
      },
      plugins: {
        trigger: new FormValidation.plugins.Trigger({
          event: {
            password: false,
          },
        }),
        bootstrap: new FormValidation.plugins.Bootstrap5({
          rowSelector: ".fv-row",
          eleInvalidClass: "", // comment to enable invalid state icons
          eleValidClass: "", // comment to enable valid state icons
        }),
      },
    });

    // Handle form submit
    submitButton.addEventListener("click", function (e) {
      e.preventDefault();

      validator.revalidateField("password");

      if ($("div").is(".cf-turnstile") == true) {
        var datas = {
          email: $("#email").val(),
          passwd: $("#passwd").val(),
          repasswd: $("#repasswd").val(),
          code: $("#referral_code").val(),
          turnstile: turnstile.getResponse(),
        };
      } else {
        datas = {
          email: $("#email").val(),
          passwd: $("#passwd").val(),
          repasswd: $("#repasswd").val(),
          code: $("#referral_code").val(),
        };
      }

      validator.validate().then(function (status) {
        if (status == "Valid") {
          // Show loading indication
          submitButton.setAttribute("data-kt-indicator", "on");

          // Disable button to avoid multiple click
          submitButton.disabled = true;

          // Simulate ajax request
          setTimeout(function () {
            // Show message popup. For more info check the plugin's official documentation: https://sweetalert2.github.io/
            $.ajax({
              method: "POST",
              url: "/auth/signup",
              dataType: "json",
              data: datas,
              success: function (data) {
                if (data.ret == 1) {
                  Swal.fire({
                    text: data.msg,
                    icon: "success",
                    buttonsStyling: !1,
                    confirmButtonText: "OK",
                    customClass: {
                      confirmButton: "btn btn-primary",
                    },
                  }).then(function (result) {
                    if (result.isConfirmed) {
                      form.reset(); // reset form
                      passwordMeter.reset(); // reset password meter

                      //form.submit();

                      //form.submit(); // submit form
                      var redirectUrl = form.getAttribute(
                        "data-kt-redirect-url"
                      );
                      if (redirectUrl) {
                        location.href = redirectUrl;
                      }
                    }
                  });
                } else {
                  Swal.fire({
                    text: data.msg,
                    icon: "error",
                    buttonsStyling: !1,
                    confirmButtonText: "OK",
                    customClass: {
                      confirmButton: "btn btn-primary",
                    },
                  });
                  // Hide loading indication
                  submitButton.removeAttribute("data-kt-indicator");

                  // Enable button
                  submitButton.disabled = false;
                }
              },
            });
          }, 1500);
        } else {
          // Show error popup. For more info check the plugin's official documentation: https://sweetalert2.github.io/
          Swal.fire({
            text: i18next.t("Đã phát hiện một số lỗi, vui lòng thử lại"),
            icon: "error",
            buttonsStyling: false,
            confirmButtonText: "OK, got it!",
            customClass: {
              confirmButton: "btn btn-primary",
            },
          });
        }
      });
    });

    // Handle password input
    form
      .querySelector('input[name="password"]')
      .addEventListener("input", function () {
        if (this.value.length < 8) {
          validator.updateFieldStatus("password", "NotValidated");
        }
      });
  };

  // Password input validation
  var validatePassword = function () {
    return passwordMeter.getScore() === 100;
  };

  // Public functions
  return {
    // Initialization
    init: function () {
      // Elements
      form = document.querySelector("#kt_sign_up_form");
      submitButton = document.querySelector("#kt_sign_up_submit");
      passwordMeter = KTPasswordMeter.getInstance(
        form.querySelector('[data-kt-password-meter="true"]')
      );

      handleForm();
    },
  };
})();

// On document ready
KTUtil.onDOMContentLoaded(function () {
  KTSignupGeneral.init();
});

function getQueryVariable(variable) {
  var query = window.location.search.substring(1);
  var vars = query.split("&");
  for (var i = 0; i < vars.length; i++) {
    var pair = vars[i].split("=");
    if (pair[0] == variable) {
      return pair[1];
    }
  }
  return "";
}
function setCookie(cname, cvalue, exdays) {
  var d = new Date();
  d.setTime(d.getTime() + exdays * 24 * 60 * 60 * 1000);
  var expires = "expires=" + d.toGMTString();
  document.cookie = cname + "=" + cvalue + "; " + expires;
}
function getCookie(cname) {
  var name = cname + "=";
  var ca = document.cookie.split(";");
  for (var i = 0; i < ca.length; i++) {
    var c = ca[i].trim();
    if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
  }
  return "";
}
if (getQueryVariable("code") != "") {
  setCookie("code", getQueryVariable("code"), 30);
  window.location.href = "/auth/signup";
}
if (getCookie("code") != "") {
  $("#referral_code").val(getCookie("code"));
}
